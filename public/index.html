<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Sistema Distribuidora</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            text-align: center;
        }

        .header h1 {
            color: #2c3e50;
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .header p {
            color: #7f8c8d;
            font-size: 1.1rem;
            margin-bottom: 20px;
        }

        .tabs-container {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
        }

        .tab-btn {
            padding: 12px 24px;
            border: 2px solid #3498db;
            border-radius: 8px;
            background: white;
            color: #3498db;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .tab-btn:hover {
            background: #3498db;
            color: white;
            transform: translateY(-2px);
        }

        .tab-btn.active {
            background: #3498db;
            color: white;
            box-shadow: 0 4px 12px rgba(52, 152, 219, 0.3);
        }

        .table-container {
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .table-header {
            background: #2c3e50;
            color: white;
            padding: 25px;
            text-align: center;
        }

        .table-content {
            overflow-x: auto;
            max-height: 600px;
            overflow-y: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }

        th {
            background: #34495e;
            color: white;
            padding: 15px 10px;
            text-align: left;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        td {
            padding: 12px 10px;
            border-bottom: 1px solid #ecf0f1;
            vertical-align: middle;
        }

        tr:hover {
            background-color: #f8f9fa;
        }

        .loading {
            text-align: center;
            padding: 50px;
            color: #7f8c8d;
            font-size: 1.1rem;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 20px;
            border-radius: 8px;
            margin: 20px;
            text-align: center;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #3498db;
            color: white;
            margin: 10px;
        }

        .btn:hover {
            background: #2980b9;
            transform: translateY(-2px);
        }

        .precio {
            text-align: right;
            font-weight: 600;
            color: #27ae60;
        }

        .cantidad {
            text-align: center;
            font-weight: 600;
            color: #7f8c8d;
        }

        .detalle-id {
            font-weight: 600;
            color: #3498db;
        }

        .pedido-id {
            font-weight: 600;
            color: #9b59b6;
        }

        .pedido-card {
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            margin-bottom: 15px;
            overflow: hidden;
        }

        .pedido-header {
            background: #f8f9fa;
            padding: 15px;
            border-bottom: 1px solid #e0e0e0;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .pedido-header:hover {
            background: #e9ecef;
        }

        .pedido-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            align-items: center;
        }

        .pedido-field {
            display: flex;
            flex-direction: column;
        }

        .pedido-label {
            font-size: 0.8rem;
            color: #6c757d;
            font-weight: 500;
        }

        .pedido-value {
            font-weight: 600;
            color: #2c3e50;
        }

        .estado-confirmado {
            color: #28a745;
        }

        .estado-pendiente {
            color: #ffc107;
        }

        .estado-borrador {
            color: #6c757d;
        }

        .detalles-container {
            padding: 0;
        }

        .detalles-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
        }

        .detalles-table th {
            background: #495057;
            color: white;
            padding: 10px 8px;
            font-size: 0.8rem;
        }

        .detalles-table td {
            padding: 8px;
            border-bottom: 1px solid #f0f0f0;
        }

        .detalles-table tr:hover {
            background-color: #f8f9fa;
        }

        .observacion {
            background: #fff3cd;
            padding: 8px 12px;
            border-radius: 4px;
            font-style: italic;
            color: #856404;
            margin-top: 5px;
        }

        .expand-icon {
            float: right;
            transition: transform 0.3s ease;
        }

        .pedido-card[open] .expand-icon {
            transform: rotate(180deg);
        }

        .estado-selector {
            padding: 5px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: white;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .estado-selector:hover {
            border-color: #007bff;
        }

        .estado-selector:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 2px rgba(0,123,255,0.25);
        }

        .total-destacado {
            font-size: 1.1rem;
            font-weight: 700;
            color: #28a745;
        }

        .acciones-pedido {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #e0e0e0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .loading-estado {
            font-size: 0.8rem;
            color: #6c757d;
            font-style: italic;
        }

        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .pedido-info {
                grid-template-columns: 1fr;
            }
            
            .detalles-table {
                font-size: 0.8rem;
            }
            
            .detalles-table th,
            .detalles-table td {
                padding: 8px 6px;
            }
            
            .acciones-pedido {
                flex-direction: column;
                align-items: stretch;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìã Dashboard Distribuidora</h1>
            <p>Sistema de gesti√≥n de pedidos</p>
            <button class="btn" onclick="cargarDatos()">üîÑ Cargar Datos</button>
            
            <div class="tabs-container">
                <button class="tab-btn active" id="tab-all" onclick="showPedidos('all')">
                    üìã Todos los Pedidos
                </button>
                <button class="tab-btn" id="tab-pending" onclick="showPedidos('pending')">
                    ‚è≥ Pedidos Pendientes
                </button>
            </div>
        </div>

        <div class="table-container">
            <div class="table-header" id="tableHeader">
                <h2>üìä Todos los Pedidos</h2>
            </div>
            <div class="table-content" id="contenidoTabla">
                <div class="loading">Presiona "Cargar Datos" para comenzar</div>
            </div>
        </div>
    </div>

    <script>
        // Variable global para almacenar todos los pedidos
        let allPedidos = [];
        let currentFilter = 'all';

        async function cargarDatos() {
            console.log('üîÑ Iniciando carga de pedidos completos...');
            
            // Mostrar loading
            document.getElementById('contenidoTabla').innerHTML = `
                <div class="loading">üîÑ Cargando pedidos completos...</div>
            `;
            
            try {
                const respuesta = await fetch('/api/pedidos-completos');
                console.log('üì° Respuesta del servidor:', respuesta.status);
                
                if (!respuesta.ok) {
                    throw new Error(`Error HTTP: ${respuesta.status}`);
                }
                
                const datos = await respuesta.json();
                console.log('üìä Datos recibidos:', datos);
                
                // Asegurar que pedidos sea siempre un array
                const pedidos = Array.isArray(datos.pedidos) ? datos.pedidos : [];
                
                if (datos.success) {
                    // Almacenar todos los pedidos globalmente
                    allPedidos = pedidos;
                    // Mostrar seg√∫n el filtro actual
                    showPedidos(currentFilter);
                } else {
                    throw new Error(datos.error || 'No se encontraron datos v√°lidos');
                }
                
            } catch (error) {
                console.error('‚ùå Error:', error);
                mostrarError(error.message);
            }
        }

        function showPedidos(filterType) {
            console.log(`üîç Mostrando pedidos: ${filterType}`);
            
            currentFilter = filterType;
            
            // Actualizar pesta√±as activas
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`tab-${filterType}`).classList.add('active');
            
            // Filtrar pedidos seg√∫n el tipo
            let pedidosFiltrados = [];
            let headerText = '';
            
            if (filterType === 'all') {
                pedidosFiltrados = allPedidos;
                headerText = 'üìä Todos los Pedidos';
            } else if (filterType === 'pending') {
                pedidosFiltrados = allPedidos.filter(pedido => 
                    (pedido.estado || 'PENDIENTE').toUpperCase() === 'PENDIENTE'
                );
                headerText = '‚è≥ Pedidos Pendientes';
            }
            
            // Actualizar header
            document.getElementById('tableHeader').innerHTML = `<h2>${headerText}</h2>`;
            
            // Mostrar pedidos filtrados
            mostrarPedidos(pedidosFiltrados);
            
            console.log(`‚úÖ Mostrando ${pedidosFiltrados.length} pedidos de ${allPedidos.length} totales`);
        }

        async function actualizarEstadoPedido(pedidoId, nuevoEstado) {
            const selector = document.getElementById(`estado-${pedidoId}`);
            const loading = document.getElementById(`loading-${pedidoId}`);
            const estadoActual = selector.dataset.estadoActual;
            
            // Si no cambi√≥ el estado, no hacer nada
            if (nuevoEstado === estadoActual) {
                return;
            }
            
            console.log(`üîÑ Actualizando pedido ${pedidoId} de ${estadoActual} a ${nuevoEstado}`);
            
            // Mostrar loading
            loading.style.display = 'inline';
            selector.disabled = true;
            
            try {
                const response = await fetch(`/api/pedidos/${pedidoId}/estado`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ estado: nuevoEstado })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    console.log(`‚úÖ Estado actualizado: ${result.message}`);
                    
                    // Actualizar el dataset para futuras comparaciones
                    selector.dataset.estadoActual = nuevoEstado;
                    
                    // Mostrar mensaje de √©xito temporal
                    loading.textContent = '‚úÖ Actualizado';
                    loading.style.color = '#28a745';
                    
                    // Recargar datos despu√©s de 1 segundo para reflejar cambios
                    setTimeout(() => {
                        // Recargar datos y mantener el filtro actual
                        cargarDatos();
                    }, 1000);
                    
                } else {
                    throw new Error(result.error || 'Error desconocido');
                }
                
            } catch (error) {
                console.error('‚ùå Error actualizando estado:', error);
                
                // Revertir selector al estado anterior
                selector.value = estadoActual;
                
                // Mostrar error
                loading.textContent = '‚ùå Error';
                loading.style.color = '#dc3545';
                
                alert(`Error al actualizar el estado: ${error.message}`);
                
            } finally {
                // Ocultar loading despu√©s de 3 segundos
                setTimeout(() => {
                    loading.style.display = 'none';
                    loading.textContent = 'Actualizando...';
                    loading.style.color = '#6c757d';
                    selector.disabled = false;
                }, 3000);
            }
        }
        function mostrarPedidos(pedidos) {
            console.log('üìã Mostrando', pedidos.length, 'pedidos');
            
            if (!pedidos || pedidos.length === 0) {
                document.getElementById('contenidoTabla').innerHTML = `
                    <div class="loading">üì≠ No hay pedidos disponibles</div>
                `;
                return;
            }

            let html = '<div style="padding: 20px;">';
            
            pedidos.forEach(pedido => {
                const estadoClass = `estado-${(pedido.estado || 'pendiente').toLowerCase()}`;
                const fechaFormateada = formatearFecha(pedido.fecha_hora);
                
                // Usar total calculado si existe, sino el total del pedido
                const totalMostrar = pedido.total_calculado || pedido.total || 0;
                const totalFormateado = formatearPrecio(totalMostrar);
                
                // Verificar si hay discrepancia entre totales
                const hayDiscrepancia = pedido.total && pedido.total_calculado && 
                    Math.abs(parseFloat(pedido.total) - parseFloat(pedido.total_calculado)) > 0.01;
                
                html += `
                    <details class="pedido-card">
                        <summary class="pedido-header">
                            <div class="pedido-info">
                                <div class="pedido-field">
                                    <span class="pedido-label">Pedido ID</span>
                                    <span class="pedido-value pedido-id">${pedido.pedido_id || '-'}</span>
                                </div>
                                <div class="pedido-field">
                                    <span class="pedido-label">Cliente</span>
                                    <span class="pedido-value">${pedido.cliente_nombre || '-'}</span>
                                </div>
                                <div class="pedido-field">
                                    <span class="pedido-label">Fecha</span>
                                    <span class="pedido-value">${fechaFormateada}</span>
                                </div>
                                <div class="pedido-field">
                                    <span class="pedido-label">Items</span>
                                    <span class="pedido-value cantidad">${pedido.items_cantidad || pedido.detalles?.length || 0}</span>
                                </div>
                                <div class="pedido-field">
                                    <span class="pedido-label">Total</span>
                                    <span class="pedido-value precio total-destacado">$${totalFormateado}</span>
                                    ${hayDiscrepancia ? '<br><small style="color: #dc3545;">‚ö†Ô∏è Total recalculado</small>' : ''}
                                </div>
                                <div class="pedido-field">
                                    <span class="pedido-label">Estado</span>
                                    <span class="pedido-value ${estadoClass}">${pedido.estado || 'PENDIENTE'}</span>
                                </div>
                            </div>
                            <span class="expand-icon">‚ñº</span>
                        </summary>
                        
                        <div class="detalles-container">
                            ${pedido.observaciones ? `<div class="observacion">üìù ${pedido.observaciones}</div>` : ''}
                            
                            <div class="acciones-pedido">
                                <label for="estado-${pedido.pedido_id}"><strong>Cambiar estado:</strong></label>
                                <select id="estado-${pedido.pedido_id}" class="estado-selector" 
                                        onchange="actualizarEstadoPedido('${pedido.pedido_id}', this.value)"
                                        data-estado-actual="${pedido.estado || 'PENDIENTE'}">
                                    <option value="PENDIENTE" ${(pedido.estado || 'PENDIENTE') === 'PENDIENTE' ? 'selected' : ''}>‚è≥ PENDIENTE</option>
                                    <option value="CONFIRMADO" ${pedido.estado === 'CONFIRMADO' ? 'selected' : ''}>‚úÖ CONFIRMADO</option>
                                    <option value="CANCELADO" ${pedido.estado === 'CANCELADO' ? 'selected' : ''}>‚ùå CANCELADO</option>
                                </select>
                                <span id="loading-${pedido.pedido_id}" class="loading-estado" style="display: none;">Actualizando...</span>
                            </div>
                            
                            ${pedido.detalles && pedido.detalles.length > 0 ? `
                                <table class="detalles-table">
                                    <thead>
                                        <tr>
                                            <th>Producto</th>
                                            <th>Cantidad</th>
                                            <th>Precio Unit.</th>
                                            <th>Importe</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${pedido.detalles.map(detalle => `
                                            <tr>
                                                <td>${detalle.producto_nombre || '-'}</td>
                                                <td class="cantidad">${detalle.cantidad || 0}</td>
                                                <td class="precio">$${formatearPrecio(detalle.precio_unitario || 0)}</td>
                                                <td class="precio">$${formatearPrecio(detalle.importe || 0)}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            ` : '<p style="padding: 20px; text-align: center; color: #6c757d;">No hay detalles disponibles</p>'}
                        </div>
                    </details>
                `;
            });
            
            html += '</div>';

            document.getElementById('contenidoTabla').innerHTML = html;
            console.log('‚úÖ Pedidos mostrados exitosamente');
        }

        function mostrarError(mensaje) {
            document.getElementById('contenidoTabla').innerHTML = `
                <div class="error">
                    <h3>‚ùå Error</h3>
                    <p>${mensaje}</p>
                    <button class="btn" onclick="cargarDatos()">üîÑ Reintentar</button>
                </div>
            `;
        }

        function formatearPrecio(precio) {
            return new Intl.NumberFormat('es-AR').format(precio);
        }

        function formatearFecha(fechaHora) {
            if (!fechaHora) return '-';
            
            try {
                // Manejar diferentes formatos de fecha
                let fecha;
                
                // Si es formato ISO (2024-01-15T10:30:00.000Z)
                if (fechaHora.includes('T') || fechaHora.includes('Z')) {
                    fecha = new Date(fechaHora);
                } 
                // Si es formato local (15/01/2024 10:30:00)
                else if (fechaHora.includes('/')) {
                    // Convertir formato DD/MM/YYYY HH:mm:ss a formato ISO
                    const parts = fechaHora.split(' ');
                    const datePart = parts[0]; // DD/MM/YYYY
                    const timePart = parts[1] || '00:00:00'; // HH:mm:ss
                    
                    const [day, month, year] = datePart.split('/');
                    const isoString = `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}T${timePart}`;
                    fecha = new Date(isoString);
                }
                // Otros formatos
                else {
                    fecha = new Date(fechaHora);
                }
                
                // Verificar si la fecha es v√°lida
                if (isNaN(fecha.getTime())) {
                    console.warn('Fecha inv√°lida:', fechaHora);
                    return fechaHora; // Devolver el texto original si no se puede parsear
                }
                
                return fecha.toLocaleString('es-AR', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            } catch (error) {
                console.warn('Error formateando fecha:', fechaHora, error);
                return fechaHora;
            }
        }
    </script>
</body>
</html>